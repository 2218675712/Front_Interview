# 父组件嵌套 子组件，两个组件都有useEffect，执行顺序是什么样的

1. **渲染阶段 (Render Phase):**  React 调用组件函数来计算它们的输出（JSX）。这个阶段是同步的，并且是自上而下（父组件先于子组件）执行的。
2. **提交阶段 (Commit Phase):**  React 更新实际的 DOM。在这个阶段之后，或者在 DOM 更新期间，`useEffect` 的回调函数才会被执行。`useEffect` 的回调是**异步**执行的（相对于浏览器绘制）。

## 为什么是这样的顺序？

- **渲染：父**  **-&gt; 子**这是自然流程。父组件决定了子组件是否存在以及传递给子组件的 props。只有父组件渲染了，子组件才能被渲染。
- **`useEffect`** **设置 (Mount/Update)：子-&gt;父**这种顺序确保了当父组件的 `useEffect` 执行时，子组件（及其 DOM 元素）已经完全准备就绪。例如，如果父组件的 effect 需要查询子组件创建的 DOM 元素，那么子组件的 effect 必须先完成其工作。这有助于避免在父组件的 effect 中出现 `null` 或未定义的情况。
- **`useEffect`** **清理 (Update/Unmount)：父 -&gt; 子**清理函数的顺序与设置函数相反，这通常是为了逻辑上的对称性。当组件被卸载时，先清理外部资源（父组件），再清理内部资源（子组件），这样更符合“从外到内”的解除绑定模式。

### 父子组件 `useEffect` 执行顺序总结

| 阶段 / 动作 | 具体步骤          | 执行顺序 (父 \<-\> 子) | 说明                                                         |
| ------------- | ------------------- | ------------------------------ | -------------------------------------------------------------- |
| **1. 首次挂载 (Mount)**            | `Parent` 组件函数执行     | 父 -\> 子                 | React 渲染流程，父组件先决定渲染什么。                       |
|             | `Child` 组件函数执行     |                              |                                                              |
|             | **`Child`** **组件的** **`useEffect`** **回调**               | 子 -\> 父                 | 子组件的 DOM 元素已准备就绪，其 effect 先运行。              |
|             | **`Parent`** **组件的** **`useEffect`** **回调**               |                              | 父组件的 effect 稍后运行，此时子组件已完全初始化。           |
|             |                   |                              | *注意：**`useEffect`* *回调总是在 DOM 更新后异步执行。*                                                            |
|             |                   |                              |                                                              |
| **2. 更新 (Update)**            | `Parent` 组件函数重新执行 | 父 -\> 子                 | 状态/Props 变化导致重新渲染。                                |
|             | `Child` 组件函数重新执行 |                              |                                                              |
|             | **`Parent`** **组件的** **`useEffect`** **清理函数**               | 父 -\> 子                 | 如果父组件的 effect 依赖项发生变化，旧 effect 的清理先运行。 |
|             | **`Child`** **组件的** **`useEffect`** **清理函数**               |                              | 如果子组件的 effect 依赖项发生变化，旧 effect 的清理后运行。 |
|             | DOM 更新          |                              | React 差异比较并更新真实 DOM。                               |
|             | **`Child`** **组件的** **`useEffect`** **回调**               | 子 -\> 父                 | 新的 effect 回调运行，确保子组件 DOM 再次就绪。              |
|             | **`Parent`** **组件的** **`useEffect`** **回调**               |                              | 新的 effect 回调运行。                                       |
|             |                   |                              | *注意：清理函数在下次渲染前，新 effect 执行前运行。*                                                             |
|             |                   |                              |                                                              |
| **3. 卸载 (Unmount)**            | **`Parent`** **组件的** **`useEffect`** **清理函数**               | 父 -\> 子                 | 组件从 DOM 中移除，父组件的清理先执行。                      |
|             | **`Child`** **组件的** **`useEffect`** **清理函数**               |                              | 子组件的清理后执行。                                         |
|             |                   |                              | *用于释放资源，如取消订阅、清除定时器等。*                                                             |

---

**关键点总结：**

- **渲染 (Render):**  总是 **父**-\> **子**。
- **`useEffect`** **设置 (Effect Callback):**  总是 **子** -\>**父**（挂载和更新时）。
- **`useEffect`** **清理 (Cleanup Function):**  总是 **父** -\> **子**（更新和卸载时）。
- **时机：**  `useEffect` 的回调函数总是在 DOM 更新完成后**异步**执行。清理函数在下一次 effect 运行前或组件卸载时运行。
- **依赖项 (****`deps`** **):**  `useEffect` 的依赖项数组决定了何时重新运行 effect 或其清理函数。如果没有依赖项 (`[]`)，则只在挂载和卸载时运行。